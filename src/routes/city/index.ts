import { Request, Response, Router } from "express";
import Credentials from "../../database/Credentials";
import qrcode from "qrcode";
import createCredential from "../../utils/createCredential";
import { sign } from "crypto";

const router = Router();

interface CitySubmitInfo {
  givenName: string;
  familyName: string;
  address: string;
  birthDate: string;
}

router.post("/cred", async (req: Request, res: Response) => {
  const body = req.body as CitySubmitInfo;

  const c = await Credentials.findOne({});
  const did = (c as any).did;

  const unsignedVC = {
    "@context": [
      "https://www.w3.org/2018/credentials/v1",
      "https://schema.org",
    ],
    name: "City ID",
    image: "data:image/png;base64,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",
    type: ["VerifiableCredential", "FlexLandCityIDCredential"],
    credentialSubject: {
      id: did,
      givenName: body.givenName,
      familyName: body.familyName,
      address: body.address,
      birthDate: body.birthDate,
    },
    issuerOrganization: "Flex Land",
    issuer: process.env.ORG_DID,
    saveToBank: true,
    isRevocable: false,
  };

  console.log(unsignedVC);

  const signedVc = await createCredential(unsignedVC);

  console.log(signedVc);
  (c as any).cityId = signedVc;
  await c.save();

  const saveRequest = {
    requestType: "credentialSave",
    vc: signedVc,
  };

  const vcQR = await qrcode.toDataURL(JSON.stringify(saveRequest));
  return res.json({
    qrcode: vcQR,
  });
});

export default router;
