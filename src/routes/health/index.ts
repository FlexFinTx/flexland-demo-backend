import { Request, Response, Router } from "express";
import qrcode from "qrcode";
import Credentials from "../../database/Credentials";
import PRequests from "../../database/PresentationRequests";
import PresentationRequestTemplates from "../../database/PresentationRequestTemplates";
import Submissions from "../../database/PresentationSubmissions";
import createCredential from "../../utils/createCredential";
import createPresentationRequest from "../../utils/createPresentationRequest";
import fetchSubmission from "../../utils/fetchSubmission";
import generateRandomString from "../../utils/generateRandomString";

const router = Router();

router.get("/pr", async (req: Request, res: Response) => {
  const prt = await PresentationRequestTemplates.findOne({});
  const cityTemplateId = (prt as any).city as string;
  const insuranceTemplateId = (prt as any).insurance as string;

  const templateIds = [cityTemplateId, insuranceTemplateId];

  const pr = await createPresentationRequest(templateIds);

  const show = {
    requestType: "presentationRequest",
    pr,
  };

  const prmodel = await PRequests.findOne({});
  (prmodel as any).health = pr.id;
  await prmodel.save();

  const prQR = await qrcode.toDataURL(JSON.stringify(show));
  return res.json({
    qrcode: prQR,
  });
});

router.get("/poll", async (req: Request, res: Response) => {
  const prmodel = await PRequests.findOne({});

  const response = await fetchSubmission((prmodel as any).health);

  if (response === "NA") {
    return res.sendStatus(400);
  } else {
    const submission = await Submissions.findOne({});
    (submission as any).health = response;
    await submission.save();
    return res.sendStatus(200);
  }
});

router.post("/cred", async (req: Request, res: Response) => {
  const c = await Credentials.findOne({});
  const did = (c as any).did;

  const unsignedVC = {
    "@context": [
      "https://www.w3.org/2018/credentials/v1",
      "https://schema.org",
    ],
    type: ["VerifiableCredential", "FlexLandHealthIDCredential"],
    name: "Health ID",
    image: "data:image/png;base64,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",
    issuerOrganization: "St. Generals",
    credentialSubject: {
      id: did,
      healthcareInstitution: "St. Generals Hospital",
      patientId: generateRandomString(15).toUpperCase(),
      tagId: generateRandomString(5).toUpperCase(),
    },
    issuer: process.env.ORG_DID,
    saveToBank: true,
    isRevocable: false,
  };

  const signedVc = await createCredential(unsignedVC);
  (c as any).healthId = signedVc;
  await c.save();

  const saveRequest = {
    requestType: "credentialSave",
    vc: signedVc,
  };

  const vcQR = await qrcode.toDataURL(JSON.stringify(saveRequest));
  return res.json({
    qrcode: vcQR,
  });
});

export default router;
